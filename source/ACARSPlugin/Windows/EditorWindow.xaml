<Window x:Class="ACARSPlugin.Windows.EditorWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:local="clr-namespace:ACARSPlugin"
        xmlns:controls="clr-namespace:ACARSPlugin.Controls"
        xmlns:viewModels="clr-namespace:ACARSPlugin.ViewModels"
        Background="{x:Static local:Theme.BackgroundColor}"
        d:DataContext="{d:DesignInstance Type=viewModels:EditorViewModel}"
        mc:Ignorable="d"
        Title="{Binding Callsign}"
        Width="640"
        SizeToContent="Height"
        ResizeMode="NoResize">
    <Window.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/ACARSPlugin;component/Styles.xaml" />
            </ResourceDictionary.MergedDictionaries>
            
            <Style TargetType="Button" BasedOn="{StaticResource ButtonBaseStyle}"/>

            <Style x:Key="DownlinkMessageBackground" TargetType="Border">
                <Setter Property="Background" Value="{x:Static local:Theme.InteractiveTextColor}"/>
                <Style.Triggers>
                    <DataTrigger Value="True">
                        <DataTrigger.Binding>
                            <MultiBinding Converter="{StaticResource EqualityConverter}" Mode="OneWay">
                                <Binding Mode="OneWay"/>
                                <Binding Path="DataContext.SelectedDownlinkMessage" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType={x:Type Window}}" Mode="OneWay"/>
                            </MultiBinding>
                        </DataTrigger.Binding>
                        <Setter Property="Background" Value="{x:Static local:Theme.CPDLCSelectedDownlinkBackgroundColor}"/>
                    </DataTrigger>
                </Style.Triggers>
            </Style>

            <Style x:Key="DownlinkMessageText" TargetType="TextBlock" BasedOn="{StaticResource InteractiveTextStyle}">
                <Setter Property="Foreground" Value="{x:Static local:Theme.CPDLCSelectedDownlinkBackgroundColor}"/>
                <Style.Triggers>
                    <DataTrigger Value="True">
                        <DataTrigger.Binding>
                            <MultiBinding Converter="{StaticResource EqualityConverter}" Mode="OneWay">
                                <Binding Mode="OneWay"/>
                                <Binding Path="DataContext.SelectedDownlinkMessage" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType={x:Type Window}}" Mode="OneWay"/>
                            </MultiBinding>
                        </DataTrigger.Binding>
                        <Setter Property="Foreground" Value="{x:Static local:Theme.InteractiveTextColor}"/>
                    </DataTrigger>
                </Style.Triggers>
            </Style>

            <Style x:Key="MessageClassButton" TargetType="Button" BasedOn="{StaticResource ButtonBaseStyle}">
                <Setter Property="Height" Value="28"/>
                <Setter Property="Margin" Value="1"/>
                
                <Style.Triggers>
                    <DataTrigger Value="True">
                        <DataTrigger.Binding>
                            <MultiBinding Converter="{StaticResource EqualityConverter}" Mode="OneWay">
                                <Binding Mode="OneWay"/>
                                <Binding Path="DataContext.SelectedMessageCategory" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType={x:Type Window}}" Mode="OneWay"/>
                            </MultiBinding>
                        </DataTrigger.Binding>
                        
                        <Setter Property="Background" Value="{x:Static local:Theme.InteractiveTextColor}"/>
                        <Setter Property="Foreground" Value="{x:Static local:Theme.BackgroundColor}"/>
                    </DataTrigger>
                </Style.Triggers>
            </Style>
            
            <Style x:Key="Mode2Button" TargetType="Button" BasedOn="{StaticResource ButtonBaseStyle}">
                <Setter Property="Width" Value="80"/>
                <Setter Property="Height" Value="32"/>
                <Setter Property="Margin" Value="4"/>
            </Style>
            
            <Style x:Key="HotButton" TargetType="Button" BasedOn="{StaticResource Mode2Button}">
                <Setter Property="Foreground" Value="White"/>
                <Setter Property="Background" Value="{x:Static local:Theme.CPDLCHotButtonBackgroundColor}"/>
            </Style>
            
            <Style x:Key="SendButton" TargetType="Button" BasedOn="{StaticResource ButtonBaseStyle}">
                <Setter Property="MinWidth" Value="80"/>
                <Setter Property="Foreground" Value="White"/>
                <Setter Property="Background" Value="{x:Static local:Theme.CPDLCSendBackgroundColor}"/>
            </Style>

            <Style x:Key="LineNumberButton" TargetType="Button" BasedOn="{StaticResource ButtonBaseStyle}">
                <Setter Property="Width" Value="24"/>
                <Setter Property="Height" Value="24"/>
                <Setter Property="Margin" Value="0,0,4,0"/>
                <Setter Property="FontSize" Value="10"/>
                <Setter Property="Foreground" Value="{x:Static local:Theme.InteractiveTextColor}"/>
                <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
            </Style>

            <Style x:Key="TemplateButton" TargetType="Button" BasedOn="{StaticResource ButtonBaseStyle}">
                <Setter Property="Height" Value="20"/>
                <Setter Property="Padding" Value="4,0,4,0"/>
                <Setter Property="Margin" Value="0"/>
                <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
            </Style>
            
            <Style x:Key="ActionButton" TargetType="Button" BasedOn="{StaticResource ButtonBaseStyle}">
                <Setter Property="Width" Value="64"/>
                <Setter Property="Height" Value="32"/>
            </Style>

            <Style TargetType="TextBlock" BasedOn="{StaticResource GenericTextStyle}" />
        </ResourceDictionary>
    </Window.Resources>

    <Grid>
        <!-- Extended Downlink Message Popup -->
        <Popup x:Name="ExtendedDownlinkMessagePopup"
               StaysOpen="False"
               AllowsTransparency="True"
               Placement="Relative"
               Closed="ExtendedDownlinkMessagePopup_Closed">
            <Border Style="{StaticResource DownlinkMessageBackground}"
                    Height="20"
                    MouseDown="ExtendedDownlinkMessagePopup_MouseDown">
                <TextBlock Text="{Binding CurrentlyExtendedDownlinkMessage.FullDisplayText}"
                           Style="{StaticResource DownlinkMessageText}"/>
            </Border>
        </Popup>

        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="60"/>
                <RowDefinition Height="80"/>
                <RowDefinition Height="128"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
        
        <!-- Downlink Messages -->
        <ListBox
            Grid.Row="0"
            Margin="8"
            ItemsSource="{Binding DownlinkMessages}"
            SelectedItem="{Binding SelectedDownlinkMessage}">
            <ListBox.ItemTemplate>
                <DataTemplate DataType="{x:Type viewModels:DownlinkMessageViewModel}">
                    <Border Style="{StaticResource DownlinkMessageBackground}"
                            Height="20"
                            MouseLeftButtonDown="DownlinkMessage_Click"
                            MouseRightButtonDown="DownlinkMessage_RightClick">
                        <TextBlock Text="{Binding DisplayText}"
                                   Style="{StaticResource DownlinkMessageText}"/>
                    </Border>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>
        
        <!-- Message Class Button (Mode 1) -->
        <ItemsControl Grid.Row="1" Margin="8" ItemsSource="{Binding MessageCategoryNames}" Visibility="{Binding ShowMessageCategories, Converter={StaticResource BoolToVisibilityConverter}}">
            <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                    <UniformGrid Columns="7" Rows="2"/>
                </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemTemplate>
                <DataTemplate>
                    <Button Content="{Binding .}"
                            Command="{Binding DataContext.SelectMessageCategoryCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                            CommandParameter="{Binding .}"
                            Style="{StaticResource MessageClassButton}"/>
                </DataTemplate>
            </ItemsControl.ItemTemplate>
        </ItemsControl>
        
        <!-- Hot Buttons (Mode 2) -->
        <Grid Grid.Row="1" Visibility="{Binding ShowHotButtons, Converter={StaticResource BoolToVisibilityConverter}}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            
            <controls:BeveledLine Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="5" Height="{x:Static local:Theme.BeveledLineWidth}" Flipped="true"/>
        
            <!-- Delay Response section -->
            <Grid Grid.Row="1" Grid.Column="0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="30"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
        
                <TextBlock Grid.Row="0" Text="Delay Response" TextAlignment="Center"/>
        
                <WrapPanel Grid.Row="1" HorizontalAlignment="Center">
                    <Button Content="Standby" Style="{StaticResource HotButton}" Command="{Binding SendStandbyUplinkMessageCommand}"/>
                    <Button Content="Deferred" Style="{StaticResource HotButton}" Command="{Binding DeferCommand}" />
                </WrapPanel>
            </Grid>
        
            <controls:BeveledLine Grid.Row="1" Grid.Column="1" Width="{x:Static local:Theme.BeveledLineWidth}" Orientation="Vertical" Flipped="true"/>
        
            <!-- To Editor section -->
            <Grid Grid.Row="1" Grid.Column="2">
                <Grid.RowDefinitions>
                    <RowDefinition Height="30"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
        
                <TextBlock Grid.Row="0" Text="To Editor" TextAlignment="Center"/>
        
                <WrapPanel Grid.Row="1" HorizontalAlignment="Center">
                    <Button Content="Edit" Style="{StaticResource Mode2Button}" Command="{Binding EditCommand}" />
                </WrapPanel>
            </Grid>
        
            <controls:BeveledLine Grid.Row="1" Grid.Column="3" Width="{x:Static local:Theme.BeveledLineWidth}" Orientation="Vertical" Flipped="true"/>
        
            <!-- Unable section -->
            <Grid Grid.Row="1" Grid.Column="4">
                <Grid.RowDefinitions>
                    <RowDefinition Height="30"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
        
                <TextBlock Grid.Row="0" Text="Unable Due To" TextAlignment="Center"/>
        
                <WrapPanel Grid.Row="1" HorizontalAlignment="Center">
                    <Button Content="Traffic" Style="{StaticResource HotButton}" Command="{Binding SendUnableDueTrafficUplinkMessageCommand}" />
                    <Button Content="Airspace" Style="{StaticResource HotButton}" Command="{Binding SendUnableDueAirspaceUplinkMessageCommand}" />
                </WrapPanel>
            </Grid>
            
            <controls:BeveledLine Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="5" Height="{x:Static local:Theme.BeveledLineWidth}" Flipped="true"/>
        </Grid>
        
        <!-- Class Elements Display Area -->
        <!-- TODO: Prefix with * if the text needs to overflow. Right-click to extend the display area. -->
        <!-- TODO: Prefix with F if uplink id is 169 -->
        <!-- TODO: Prefix with E if uplink id is 170 -->
        <ScrollViewer
            Grid.Row="2"
            Margin="8"
            Style="{StaticResource CustomScrollViewerStyle}">
            <ItemsControl ItemsSource="{Binding SelectedMessageCategoryElements}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Border Background="Transparent" Padding="4,2" Margin="0">
                            <TextBlock
                                Text="{Binding DisplayText}"
                                Style="{StaticResource InteractiveTextStyle}"
                                MouseLeftButtonDown="MessageClassElement_Click"/>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>
        
        <!-- Message Construction Area -->
        <Grid Grid.Row="3" Margin="8">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Line Number Buttons -->
            <ItemsControl
                Grid.Column="0"
                ItemsSource="{Binding UplinkMessageElements}"
                Focusable="False">
                <ItemsControl.ItemTemplate>
                    <DataTemplate DataType="{x:Type viewModels:UplinkMessageElementViewModel}">
                        <Button Height="24"
                                Margin="0,2,4,2"
                                VerticalAlignment="Top"
                                PreviewMouseDown="LineNumberButton_Click">
                            <Button.Style>
                                <Style TargetType="Button" BasedOn="{StaticResource LineNumberButton}">
                                    <Style.Triggers>
                                        <DataTrigger Value="True">
                                            <DataTrigger.Binding>
                                                <MultiBinding Converter="{StaticResource EqualityConverter}" Mode="OneWay">
                                                    <Binding Mode="OneWay"/>
                                                    <Binding Path="DataContext.SelectedUplinkMessageElement" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType={x:Type Window}}" Mode="OneWay"/>
                                                </MultiBinding>
                                            </DataTrigger.Binding>
                                            <Setter Property="Background" Value="{x:Static local:Theme.InteractiveTextColor}"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                            <TextBlock>
                                <TextBlock.Style>
                                    <Style BasedOn="{StaticResource InteractiveTextStyle}" TargetType="TextBlock">
                                        <Style.Triggers>
                                            <DataTrigger Value="True">
                                                <DataTrigger.Binding>
                                                    <MultiBinding Converter="{StaticResource EqualityConverter}" Mode="OneWay">
                                                        <Binding Mode="OneWay"/>
                                                        <Binding Path="DataContext.SelectedUplinkMessageElement" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType={x:Type Window}}" Mode="OneWay"/>
                                                    </MultiBinding>
                                                </DataTrigger.Binding>
                                                <Setter Property="Foreground" Value="{x:Static local:Theme.BackgroundColor}"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                                <TextBlock.Text>
                                    <MultiBinding Converter="{StaticResource IndexInCollectionConverter}" FallbackValue="?">
                                        <Binding FallbackValue="{x:Null}"/>
                                        <Binding Path="ItemsSource" RelativeSource="{RelativeSource AncestorType=ItemsControl}" FallbackValue="{x:Null}"/>
                                    </MultiBinding>
                                </TextBlock.Text>
                            </TextBlock>
                        </Button>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

            <!-- Message Elements -->
            <controls:BeveledBorder
                Grid.Column="1"
                BevelType="Sunken"
                BorderThickness="{x:Static local:Theme.BeveledBorderThickness}"
                Focusable="False">
                <ItemsControl
                    ItemsSource="{Binding UplinkMessageElements}"
                    Focusable="False">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate DataType="{x:Type viewModels:UplinkMessageElementViewModel}">
                            <Border Height="24"
                                    Margin="0,2,0,2"
                                    VerticalAlignment="Top">
                                <Border.Style>
                                    <Style TargetType="Border">
                                        <Setter Property="BorderBrush" Value="Transparent"/>
                                        <Style.Triggers>
                                            <DataTrigger Value="True">
                                                <DataTrigger.Binding>
                                                    <MultiBinding Converter="{StaticResource EqualityConverter}" Mode="OneWay">
                                                        <Binding Mode="OneWay"/>
                                                        <Binding Path="DataContext.SelectedUplinkMessageElement" RelativeSource="{RelativeSource Mode=FindAncestor, AncestorType={x:Type Window}}" Mode="OneWay"/>
                                                    </MultiBinding>
                                                </DataTrigger.Binding>
                                                <Setter Property="BorderBrush" Value="{x:Static local:Theme.SelectedUtilityColor}"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                                
                                <!-- Message Element Parts -->
                                <ItemsControl
                                    ItemsSource="{Binding Parts}"
                                    VerticalAlignment="Center"
                                    Margin="8,2,0,2">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <WrapPanel Orientation="Horizontal"/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.Resources>
                                        <!-- Template for Text Parts -->
                                        <DataTemplate DataType="{x:Type viewModels:UplinkMessageTextElementComponentViewModel}">
                                            <TextBlock Text="{Binding Value}" Style="{StaticResource GenericTextStyle}"/>
                                        </DataTemplate>

                                        <!-- Template for Template Parts -->
                                        <DataTemplate DataType="{x:Type viewModels:UplinkMessageTemplateElementComponentViewModel}">
                                            <Grid>
                                                <!-- Button shown when not editing -->
                                                <Button Style="{StaticResource TemplateButton}"
                                                        PreviewMouseDown="TemplatePartButton_MouseDown"
                                                        Visibility="{Binding IsEditing, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                                                    <TextBlock>
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock" BasedOn="{StaticResource InteractiveTextStyle}">
                                                                <!-- Default: Show value if it exists -->
                                                                <Setter Property="Text" Value="{Binding Value}"/>
                                                                <Style.Triggers>
                                                                    <!-- If Value is null or empty, show placeholder in brackets -->
                                                                    <DataTrigger Binding="{Binding Value}" Value="{x:Null}">
                                                                        <Setter Property="Text" Value="{Binding Placeholder}"/>
                                                                    </DataTrigger>
                                                                    <DataTrigger Binding="{Binding Value}" Value="">
                                                                        <Setter Property="Text" Value="{Binding Placeholder}"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>
                                                </Button>

                                                <!-- TextBox shown when editing -->
                                                <TextBox
                                                    Text="{Binding Value, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}"
                                                    Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibilityConverter}}"
                                                    IsVisibleChanged="TemplatePartTextBox_IsVisibleChanged"
                                                    PreviewKeyDown="TemplatePartTextBox_PreviewKeyDown"
                                                    LostFocus="TemplatePartTextBox_LostFocus"
                                                    CharacterCasing="Upper"
                                                    MinWidth="60"
                                                    VerticalContentAlignment="Center"/>
                                            </Grid>
                                        </DataTemplate>
                                    </ItemsControl.Resources>
                                </ItemsControl>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </controls:BeveledBorder>
        </Grid>
        
        <!-- Action Buttons -->
        <Border Grid.Row="4" BorderThickness="1" BorderBrush="{x:Static local:Theme.GenericTextColor}" Margin="8" Padding="4">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                <WrapPanel Grid.Column="0">
                    <Button Content="Escape" Style="{StaticResource ActionButton}" Margin="0,0,4,0" Command="{Binding EscapeCommand}"/>
                    <Button Content="Restore" Style="{StaticResource ActionButton}" Margin="4,0,4,0" Command="{Binding RestoreCommand}"/>
                    <Button Content="Suspend" Style="{StaticResource ActionButton}" Margin="4,0,0,0" Command="{Binding SuspendCommand}"/>
                </WrapPanel>
                
                <Button Grid.Column="1" Style="{StaticResource SendButton}" HorizontalAlignment="Right" Command="{Binding SendUplinkMessageCommand}">
                    <TextBlock Foreground="White">
                        <Run Text="Send"/>
                        <Run Text="{Binding Callsign}"/>
                    </TextBlock>
                </Button>
            </Grid>
        </Border>
        </Grid>
    </Grid>
</Window>
